let fs;
let rimraf;
fs = require('fs');
rimraf = require('rimraf');
try {
    rimraf.sync('./node_modules/spiritdependenciesTestPackage');
} catch(e) {}
try {
    rimraf.sync('./node_modules/someOtherPackage');
} catch(e) {}
describe('SpiritDependencies', function() {
    let configs, files, fs, rimraf, spiritdependencies;
    beforeEach(function() {
        configs = require('spiritconfigs/spiritconfigs.class.js');
        if (!configs.overrides.hasOwnProperty('dependencies')) {
            configs.overrides['dependencies'] = {};
        }
        configs.overrides['dependencies']['modules_folder'] = 
            'testModulesFolder';
        configs.overrides['dependencies']['modules'] = [
            'spiritdependenciesTestPackage',
            {'someOtherPackage': 'alright'}
        ];
        files = require('spiritfiles');
        files.createLocalFile('', 'node_modules/' + 
            'spiritdependenciesTestPackage/package.json', '', '', true);
        files.createLocalFile('', 'node_modules/' + 
            'spiritdependenciesTestPackage/anotherFile.json', '', '', true);
        files.createLocalFile('', 'node_modules/' + 
            'spiritdependenciesTestPackage/index.js', '// default', '', true);
        files.createLocalFile('', 'node_modules/' + 
            'someOtherPackage/package.json', '', '', true);
        files.createFile('node_modules', 
            'someTestModuleDependency/index.js', 
            'global.includedTestModuleDependency = true;', 
            'spiritdependenciesTestPackage', true);
        fs = require('fs');
        rimraf = require('rimraf');
        spiritdependencies = require(__dirname + 
            '/../spiritdependencies.class.js');
    });

    it('Should, on post-install, move the configured node_modules to modules ' + 
        'and symlink the node_modules directory.', function(done) {
            expect(fs.existsSync('./testModulesFolder')).toBe(false);
            expect(fs.existsSync('./testModulesFolder/' +
                'spiritdependenciesTestPackage')).toBe(false);
            spiritdependencies.moveModules().then(() => {
                expect(fs.existsSync(process.cwd() + '/testModulesFolder'))
                    .toBe(true);
                expect(fs.existsSync(process.cwd() + '/testModulesFolder/' +
                    'spiritdependenciesTestPackage')).toBe(true);
                expect(fs.existsSync('./node_modules/' +
                    'spiritdependenciesTestPackage/package.json')).toBe(true);
                done();
            }).catch(() => {
            });
    });
        
    it('Should, on post-install, also move moved modules node_modules ' +
        'contents back to the regular node_modules folder.', function(done) {
            expect(fs.existsSync('./node_modules/someTestModuleDependency'))
                .toBe(false);
            expect(fs.existsSync('./node_modules/' +
                'spiritdependenciesTestPackage/node_modules/' +
                'someTestModuleDependency'))
                .toBe(true);
            spiritdependencies.moveModules().then(() => {
                expect(fs.existsSync('./node_modules/someTestModuleDependency'))
                    .toBe(true);
                done();
            }).catch(() => {
            });
    });

    it('Should allow a npm update or npm install to overwrite the ' +
        'node_modules folder.', function(done) {
        expect(fs.lstatSync('node_modules/' + 'spiritdependenciesTestPackage').
            isSymbolicLink()).toBe(false);
        spiritdependencies.moveModules().then(() => {
            expect(fs.lstatSync('node_modules/' + 
                'spiritdependenciesTestPackage').isSymbolicLink()).toBe(true);
            spiritdependencies.unlinkModules();
            expect(fs.existsSync('node_modules/' + 
                'spiritdependenciesTestPackage')).toBe(false);
            done();
        }).catch(() => {
        });
    });

    it('Should not attempt to move node_modules folders that match an ' + 
        'existing module.', function(done) {
        files.createFile('node_modules', 
            'spiritdependenciesTestPackage/index.js', 
            '', 
            'spiritdependenciesTestPackage', true);
        spiritdependencies.moveModules().then(() => {
            expect(fs.existsSync(process.cwd() + '/node_modules/' +
                'spiritdependenciesTestPackage/package.json')).toBe(true);
            done();
        }).catch(() => {
        });
    });

    it('Should allow multiple dependencies to be installed, and install ' +
        'should be blocking', function(done) {
        spiritdependencies.moveModules().then(() => {
            expect(fs.existsSync(process.cwd() + '/node_modules/' +
                'someOtherPackage/package.json')).toBe(true);
            expect(fs.existsSync(process.cwd() + '/testModulesFolder/' +
                'alright/package.json')).toBe(true);
            done();
        }).catch(() => {
        });
    });

    it('Should successfully install, even if no internal node_modules ' + 
        'folder exists.', function(done) {
        spiritdependencies.moveModules().then(() => {
            expect(fs.existsSync(process.cwd() + '/testModulesFolder/' +
                'alright/package.json')).toBe(true);
            done();
        }).catch(() => {
        });
    });

    it('Should preserve changes made to working copy files in the ' +
        'target modules folder', function(done) {
            configs.overrides['dependencies']['preserveChanges'] = true;
            require(__dirname + 
                '/../spiritdependencies.class.js').configs = 
                    configs.readConfigs();
            files.createLocalFile('', 'testModulesFolder/' + 
                'spiritdependenciesTestPackage/index.js', '', '', true);
            files.createLocalFile('', 'testModulesFolder/' + 
                'spiritdependenciesTestPackage/package.json', 
                '{"changed": true}', '', true);
            setTimeout(() => {
                files.fs.utimesSync('testModulesFolder/spiritdependenciesTestPackage/package.json',
                (new Date()), (new Date()));
                spiritdependencies.moveModules().then(() => {
                    expect(fs.readFileSync('testModulesFolder/' + 
                        'spiritdependenciesTestPackage/index.js', 'UTF8'))
                            .toBe('// default');
                    expect(fs.existsSync('testModulesFolder/' + 
                        'spiritdependenciesTestPackage/anotherFile.json'))
                            .toBe(true)
                    expect(fs.readFileSync('testModulesFolder/' + 
                        'spiritdependenciesTestPackage/package.json', 'UTF8'))
                            .toBe('{"changed": true}');
                    done();
                }).catch(() => {
                });
            }, 2500);
    });

    afterEach(function() {
        rimraf.sync('./testModulesFolder');
        if (fs.existsSync('./node_modules/someTestModuleDependency')) {
            rimraf.sync('./node_modules/someTestModuleDependency');
        }
        try {
            rimraf.sync('./node_modules/spiritdependenciesTestPackage');
        } catch(e) {}
        try {
            rimraf.sync('./node_modules/someOtherPackage');
        } catch(e) {}
    });
});
