/**
 * @file
 * This file should overwrite the existing package.json to include a target 
 * called, 'run-testserver'.  It also creates a target called 'run-tests' which
 * bootstraps the tests folder and executes those tests within Jasmine.
 */
let fs = require('fs');
let json = JSON.parse(fs.readFileSync(__dirname + '/../../package.json', 
    'UTF8'));
try {
    let config = JSON.parse(fs.readFileSync(__dirname + '/configs/tests.json'));
    config['ua-uuid'] = require('uuid/v4')();
    fs.writeFileSync(__dirname + '/configs/tests.json', JSON.stringify(config));
} catch(e) {
}
json['scripts']['run-testserver'] = 'node node_modules/spirittests/' +
    'test.server.js';
json['scripts']['run-tests'] = 'node node_modules/spirittests/index.js';
fs.writeFileSync(__dirname + '/../../package.json', 
    JSON.stringify(json, null, 2));

if (!fs.existsSync(__dirname + '/../../.vscode')) {
    fs.mkdirSync(__dirname + '/../../.vscode');
}
let vscodeConfig;
if (fs.existsSync(__dirname + '/../../.vscode/launch.json')) {
    vscodeConfig = JSON.parse(fs.readFileSync(__dirname + '/../../.vscode/launch.json', 
        'UTF8').replace(/\/\/.+$/mg, ''));
} else {
    vscodeConfig = {};
}
if (vscodeConfig.hasOwnProperty('configurations')) {
    if (vscodeConfig['configurations'].findIndex((config) => {
        return config.name == 'Run Tests';
    }) == -1) {
        vscodeConfig['configurations'].push({
            type: 'node',
            request: 'launch',
            name: 'Run Tests',
            program: '${workspaceRoot}/node_modules/spirittests/index.js',
            cwd: '${workspaceRoot}',
            args: [
            ]
        });
        fs.writeFileSync(__dirname + '/../../.vscode/launch.json', 
            JSON.stringify(vscodeConfig, null, 2));
    }
} else {
    fs.writeFileSync(__dirname + '/../../.vscode/launch.json', 
        JSON.stringify({'configurations': [{
            type: 'node',
            request: 'launch',
            name: 'Run Tests',
            program: '${workspaceRoot}/node_modules/spirittests/index.js',
            cwd: '${workspaceRoot}',
            args: [
            ]
        }]}, null, 2));
}